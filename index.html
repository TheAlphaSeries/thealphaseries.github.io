<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BOM Builder</title>
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap" media="print" onload="this.media='all'">
<style>
:root{
  --bg:#0e1117;--sf:#161b22;--sf2:#1c2129;--bd:#30363d;--bdb:#484f58;
  --tx:#e6edf3;--mu:#8b949e;--red:#ff4b4b;--grn:#3fb950;--grns:rgba(63,185,80,.12);
  --blu:#58a6ff;--blus:rgba(88,166,255,.1);--yel:#d29922;--yels:rgba(210,153,34,.12);--pur:#bc8cff;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--tx);line-height:1.5}
h1{font-size:22px;font-weight:700}h2{font-size:16px;font-weight:600;margin-bottom:6px}h3{font-size:13px;font-weight:600;margin:10px 0 4px}
.cap{font-size:12px;color:var(--mu)}.mono{font-family:'IBM Plex Mono',monospace}

/* Layout */
.hdr{padding:12px 20px;border-bottom:1px solid var(--bd);display:flex;align-items:center;gap:16px;flex-wrap:wrap}
.hdr p{font-size:12px;color:var(--mu)}
.body{display:flex;min-height:calc(100vh - 50px)}
.side{width:280px;min-width:280px;background:#0d1117;border-right:1px solid var(--bd);padding:14px;overflow-y:auto}
.main{flex:1;overflow-y:auto;padding:16px 24px}

/* Inputs */
label{display:block;font-size:11px;font-weight:500;color:var(--mu);margin-bottom:1px}
select,input[type=text],input[type=number],textarea{
  width:100%;background:var(--sf2);border:1px solid var(--bd);border-radius:5px;
  padding:6px 8px;color:var(--tx);font-size:12px;font-family:inherit;outline:none;margin-bottom:6px;
}
select:focus,input:focus,textarea:focus{border-color:var(--blu)}
textarea{resize:vertical;font-family:'IBM Plex Mono',monospace;font-size:11px}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:4px;padding:6px 14px;border-radius:5px;font-size:12px;font-weight:600;font-family:inherit;cursor:pointer;border:1px solid var(--bd);background:var(--sf2);color:var(--tx);white-space:nowrap}
.btn:hover{background:var(--bd)}.btn-p{background:var(--red);border-color:var(--red);color:#fff}.btn-p:hover{opacity:.9}
.btn-g{background:var(--grn);border-color:var(--grn);color:#fff}.btn-g:hover{opacity:.9}
.btn-b{background:var(--blu);border-color:var(--blu);color:#fff}.btn-b:hover{opacity:.9}
.btn-sm{padding:4px 10px;font-size:11px}.btn:disabled{opacity:.35;cursor:not-allowed}

/* Upload */
.upl{border:1.5px dashed var(--bdb);border-radius:7px;padding:16px 12px;text-align:center;color:var(--mu);font-size:12px;cursor:pointer;position:relative;margin-bottom:6px;transition:all .2s}
.upl:hover{border-color:var(--blu)}.upl.ok{border-color:var(--grn);border-style:solid;background:var(--grns);color:var(--grn)}
.upl input{position:absolute;inset:0;opacity:0;cursor:pointer}

.hr{height:1px;background:var(--bd);margin:10px 0}

/* Tabs */
.tabs{display:flex;gap:0;border-bottom:1px solid var(--bd);margin-bottom:12px}
.tab{padding:8px 16px;font-size:12px;font-weight:600;color:var(--mu);cursor:pointer;border-bottom:2px solid transparent}
.tab:hover{color:var(--tx)}.tab.on{color:var(--blu);border-color:var(--blu)}
.tp{display:none}.tp.on{display:block}

/* Tables */
.tw{border:1px solid var(--bd);border-radius:7px;overflow:auto;margin-bottom:10px;max-height:280px}
table{width:100%;border-collapse:collapse;font-size:11.5px}
thead{background:var(--sf2);position:sticky;top:0;z-index:1}
th{padding:6px 8px;text-align:left;font-weight:600;color:var(--mu);font-size:10px;text-transform:uppercase;letter-spacing:.04em;border-bottom:1px solid var(--bd)}
td{padding:5px 8px;border-bottom:1px solid rgba(48,54,61,.4)}
tr:last-child td{border-bottom:none}tr:hover td{background:rgba(255,255,255,.015)}

.tag{display:inline-block;padding:1px 6px;border-radius:9px;font-size:10px;font-weight:600}
.tag-p{background:var(--grns);color:var(--grn)}.tag-n{background:var(--blus);color:var(--blu)}
.tag-u{background:var(--yels);color:var(--yel)}.tag-t{background:rgba(188,140,255,.1);color:var(--pur)}

.box{border-radius:7px;padding:8px 12px;font-size:12px;margin-bottom:10px}
.box-ok{background:var(--grns);border:1px solid rgba(63,185,80,.2);color:var(--grn)}
.box-w{background:var(--yels);border:1px solid rgba(210,153,34,.2);color:var(--yel)}
.box-i{background:var(--blus);border:1px solid rgba(88,166,255,.18);color:var(--blu)}

.met{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
.mc{background:var(--sf);border:1px solid var(--bd);border-radius:8px;padding:12px;text-align:center}
.mc .v{font-size:26px;font-weight:700;font-family:'IBM Plex Mono',monospace;line-height:1.1}
.mc .l{font-size:11px;color:var(--mu)}

.row{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end}
.row>*{flex:1;min-width:0}
.c2{display:grid;grid-template-columns:1.2fr 1fr;gap:24px}
.br{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}

.exp{border:1px solid var(--bd);border-radius:7px;margin-bottom:10px;overflow:hidden}
.exh{padding:7px 10px;background:var(--sf2);cursor:pointer;font-size:12px;font-weight:500;user-select:none}
.exb{padding:10px;display:none;border-top:1px solid var(--bd)}
.exp.open .exb{display:block}

.si{font-size:13px;padding:8px 12px;border-radius:7px;margin-bottom:10px}

/* Wiring Board */
.wb{display:flex;gap:12px;overflow-x:auto;padding:8px 0;margin-bottom:12px}
.sw-col{background:var(--sf);border:1px solid var(--bd);border-radius:8px;min-width:200px;max-width:240px;flex-shrink:0}
.sw-hdr{padding:8px 10px;border-bottom:1px solid var(--bd);font-size:12px;font-weight:600;text-align:center}
.sw-hdr.poe{background:#14532d;color:#4ade80}.sw-hdr.data{background:#1e3a5f;color:#60a5fa}
.port-slot{min-height:36px;padding:4px 8px;border-bottom:1px solid rgba(48,54,61,.3);display:flex;align-items:center;gap:6px;font-size:11px;transition:background .15s}
.port-slot.empty{color:var(--mu);font-style:italic}
.port-slot.drag-over{background:rgba(88,166,255,.15);outline:1px dashed var(--blu)}
.port-slot .port-lbl{color:var(--mu);font-weight:600;min-width:44px;font-size:10px}
.port-slot .dev-chip{background:var(--sf2);border:1px solid var(--bd);border-radius:4px;padding:2px 6px;font-size:11px;cursor:grab;flex:1;display:flex;align-items:center;gap:4px}
.port-slot .dev-chip:active{cursor:grabbing}
.port-slot .dev-chip .x{margin-left:auto;cursor:pointer;opacity:.5;font-size:13px}.port-slot .dev-chip .x:hover{opacity:1;color:var(--red)}
.port-slot:last-child{border-bottom:none}

/* Device pool */
.dev-pool{display:flex;flex-wrap:wrap;gap:6px;padding:8px;background:var(--sf);border:1px solid var(--bd);border-radius:8px;margin-bottom:12px;min-height:40px}
.pool-chip{background:var(--sf2);border:1px solid var(--bd);border-radius:5px;padding:4px 10px;font-size:11px;cursor:grab;display:flex;align-items:center;gap:4px}
.pool-chip:active{cursor:grabbing}
.pool-chip.poe{border-color:rgba(63,185,80,.4)}.pool-chip.non{border-color:rgba(88,166,255,.4)}

/* Mermaid preview */
#mermaidPreview{background:var(--sf);border:1px solid var(--bd);border-radius:8px;padding:16px;min-height:120px;overflow:auto;margin-bottom:12px;text-align:center}
#mermaidPreview svg{max-width:100%;height:auto}

/* Template cards */
.tpl-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin-bottom:12px}
.tpl-card{background:var(--sf);border:1px solid var(--bd);border-radius:8px;padding:12px;cursor:pointer;transition:all .15s}
.tpl-card:hover{border-color:var(--blu);background:var(--sf2)}
.tpl-card h3{font-size:13px;margin:0 0 4px;color:var(--tx)}
.tpl-card p{font-size:11px;color:var(--mu);margin:0}
.tpl-card .tpl-meta{display:flex;gap:8px;margin-top:6px;font-size:10px}
.tpl-card .tpl-act{margin-top:8px;display:flex;gap:4px}

@media(max-width:900px){.c2{grid-template-columns:1fr}.side{width:240px;min-width:240px}.wb{flex-direction:column}}
@media(max-width:700px){.body{flex-direction:column}.side{width:100%;min-width:0;border-right:none;border-bottom:1px solid var(--bd)}}
</style>
</head>
<body>

<div class="hdr">
  <h1>BOM Builder</h1>
  <p>Inventory CSV ‚Üí BOM ‚Üí Switches ‚Üí Wiring ‚Üí Mermaid Network Diagram</p>
  <div style="margin-left:auto" class="br">
    <button class="btn btn-sm" id="saveProjectBtn" title="Save project to file">üíæ Save Project</button>
    <button class="btn btn-sm" id="loadProjectBtn" title="Load project from file">üìÇ Load Project</button>
    <input type="file" id="loadProjectInput" accept=".json" style="display:none">
  </div>
</div>

<div class="body">
<aside class="side" id="side">
  <h2>1 ¬∑ Inventory CSV</h2>
  <div class="upl" id="uploadZone">üìÑ Upload CSV<input type="file" id="csvInput" accept=".csv"></div>

  <div class="hr"></div>
  <h2>2 ¬∑ Column Mapping</h2>
  <p class="cap" style="margin-bottom:6px">Auto-detected. Adjust if needed.</p>
  <div id="mapUI"></div>
  <button class="btn btn-p" style="width:100%;margin-top:2px" id="buildBtn" disabled>Build Catalog</button>
  <div id="catStatus"></div>

  <div class="hr"></div>
  <h2>3 ¬∑ Templates</h2>
  <div id="tplSidebar"></div>
</aside>

<main class="main">
  <div id="noData" class="box box-i">Upload a CSV and build the catalog, or load a saved project / template to start.</div>

  <div id="app" style="display:none">
    <div class="exp" id="catExp"><div class="exh" onclick="this.parentElement.classList.toggle('open')">üì¶ Catalog Preview</div><div class="exb"><div class="tw" id="catTbl"></div></div></div>

    <div class="tabs" id="tabBar">
      <div class="tab on" data-t="bom">‚ë† BOM</div>
      <div class="tab" data-t="sw">‚ë° Switches</div>
      <div class="tab" data-t="wire">‚ë¢ Wiring</div>
      <div class="tab" data-t="out">‚ë£ Output</div>
    </div>

    <!-- BOM -->
    <div class="tp on" id="t-bom">
      <div class="c2">
        <div>
          <h2>Search Inventory ‚Üí Add to BOM</h2>
          <input type="text" class="si" id="bomQ" placeholder="e.g., camera, JT128, switch, peplink">
          <div class="tw" id="srcTbl" style="max-height:200px"></div>
          <div class="row" style="margin-top:6px">
            <div><label>Product</label><select id="srcSel"></select></div>
            <div style="max-width:70px"><label>Qty</label><input type="number" id="addQty" value="1" min="1"></div>
            <div style="max-width:100px;padding-top:14px"><button class="btn btn-p btn-sm" id="addBomBtn">Add</button></div>
          </div>
          <p class="cap" id="stockH"></p>
        </div>
        <div>
          <h2>BOM ‚Äî Classify PoE</h2>
          <div class="exp" id="manExp"><div class="exh" onclick="this.parentElement.classList.toggle('open')">‚ûï Manual item</div><div class="exb">
            <label>Name</label><input type="text" id="mN">
            <label>Type</label><input type="text" id="mT">
            <div class="row"><div><label>Qty</label><input type="number" id="mQ" value="1" min="1"></div><div><label>PoE?</label><select id="mP"><option value="">‚Äî</option><option value="1">PoE</option><option value="0">Non-PoE</option></select></div></div>
            <button class="btn btn-sm" id="addManBtn" style="margin-top:4px">Add</button>
          </div></div>
          <div class="tw" id="bomTbl" style="max-height:220px"></div>
          <div id="bomEd"></div>
        </div>
      </div>
    </div>

    <!-- Switches -->
    <div class="tp" id="t-sw">
      <h2>Switches</h2>
      <div class="exp open"><div class="exh" onclick="this.parentElement.classList.toggle('open')">‚ûï Add Switch</div><div class="exb">
        <div class="row">
          <div><label>ID</label><input type="text" id="sI" placeholder="SWA"></div>
          <div><label>Name</label><input type="text" id="sN" placeholder="PoE Switch 1"></div>
          <div><label>Model</label><input type="text" id="sM" placeholder="PLANET IGS-5227X-4P2T"></div>
        </div>
        <div class="row">
          <div><label>Type</label><select id="sT"><option value="1">PoE</option><option value="0">Data</option></select></div>
          <div><label>PoE Ports</label><input type="number" id="sPP" value="4" min="0"></div>
          <div><label>Data Ports</label><input type="number" id="sDP" value="2" min="0"></div>
        </div>
        <label>Subtitle</label><input type="text" id="sSub" placeholder="e.g., Short Range Lidar">
        <button class="btn btn-p btn-sm" id="addSwBtn">Add Switch</button>
      </div></div>
      <div class="tw" id="swTbl"></div>
      <div id="swAct" class="br"></div>
      <div class="hr"></div>
      <h2>Daisy Chains</h2>
      <div id="dcUI"></div>
      <div class="tw" id="dcTbl"></div>
      <div id="dcAct"></div>
    </div>

    <!-- Wiring -->
    <div class="tp" id="t-wire">
      <h2>Wiring Board</h2>
      <p class="cap" style="margin-bottom:8px">Drag devices from the pool into switch port slots. Or click a slot then click a device.</p>
      <h3>Device Pool (unassigned)</h3>
      <div class="dev-pool" id="devPool"></div>
      <div class="wb" id="wireBoard"></div>
    </div>

    <!-- Output -->
    <div class="tp" id="t-out">
      <div class="row" style="margin-bottom:8px"><div><label>Diagram Title</label><input type="text" id="dTitle" value="Switch Network Diagram"></div>
        <div style="max-width:180px;padding-top:14px"><button class="btn btn-g" id="genBtn">Generate Diagram</button></div>
      </div>
      <div id="outIssues"></div>
      <div class="met" id="outMet"></div>
      <div id="outRes" style="display:none">
        <h2>Live Preview</h2>
        <div id="mermaidPreview"></div>
        <h2>Mermaid Code</h2>
        <textarea id="mOut" rows="14" readonly></textarea>
        <div class="br" style="margin-top:6px">
          <button class="btn btn-sm" id="copyBtn">üìã Copy</button>
          <button class="btn btn-sm" id="dlMmdBtn">‚¨á .mmd</button>
          <button class="btn btn-sm" id="dlBomBtn">‚¨á BOM CSV</button>
          <button class="btn btn-sm" style="border-color:rgba(63,185,80,.3);color:var(--grn)" id="dlPoeBtn">‚¨á PoE CSV</button>
          <button class="btn btn-sm" style="border-color:rgba(88,166,255,.3);color:var(--blu)" id="dlNonBtn">‚¨á Non-PoE CSV</button>
        </div>
        <div class="hr"></div>
        <h2>Save as Template</h2>
        <p class="cap" style="margin-bottom:6px">Save this switch + wiring config as a reusable template for new vehicles.</p>
        <div class="row">
          <div><label>Template Name</label><input type="text" id="tplName" placeholder="e.g., LEV05 Standard"></div>
          <div><label>Description</label><input type="text" id="tplDesc" placeholder="5 switch daisy-chain, 4x lidar"></div>
          <div style="max-width:140px;padding-top:14px"><button class="btn btn-b btn-sm" id="saveTplBtn">Save Template</button></div>
        </div>
      </div>
    </div>
  </div>
</main>
</div>

<script>
// ============================================================
// STATE
// ============================================================
const S = {
  rawRows:[],headers:[],mapping:{},catalog:{},
  bom:[],switches:[],assignments:[],chains:[],
  templates: JSON.parse(localStorage.getItem('bom_templates')||'[]'),
};

// ============================================================
// HELPERS
// ============================================================
const canon = s => (s||'').toString().trim().toUpperCase().replace(/\s+/g,'').replace(/[^A-Z0-9\-_.]/g,'');
const esc = s => (s||'').replace(/[\[\]()"']/g,'');
const nid = (n,i) => {const b=(n||'').replace(/[^A-Za-z0-9]/g,'_').slice(0,20).replace(/^_+|_+$/g,'').toUpperCase(); return (b||'D')+'_'+i;};

function pickCol(h,c){const l={};h.forEach(x=>l[x.toLowerCase().trim()]=x);for(const x of c)if(l[x.toLowerCase()])return l[x.toLowerCase()];return '';}

const CAND = {
  product_name:["Products","Product","Product Name","Item","Name","Description","MPN","Part Number"],
  product_type:["Product Type","Type","Category","Device Type"],
  asset_tag:["Asset Tag","Asset ID","Tag","Internal PN"],
  serial_number:["Serial Number","Serial","SN"],
  status:["Item Status","Status","State"],
  notes:["Notes","Note","Comments"],
  robot:["Robots","Robot","Vehicle","Machine"],
};

const POE_T=new Set(['camera','poe device','connectivity']);
const POE_K=['poe','802.3af','802.3at','802.3bt'];
const NON_T=new Set(['battery','can converter','mounting','ethernet cable','power supply','remote start','gps','sensor']);
function gPoe(n,t){const nl=(n||'').toLowerCase(),tl=(t||'').toLowerCase();if(POE_K.some(k=>nl.includes(k)))return true;if(POE_T.has(tl))return true;if(NON_T.has(tl))return false;return null;}

function csvEsc(v){const s=v==null?'':String(v);return s.includes(',')||s.includes('"')||s.includes('\n')?'"'+s.replace(/"/g,'""')+'"':s;}
function toCsv(r){if(!r.length)return'';const k=Object.keys(r[0]);return[k.map(csvEsc).join(','),...r.map(x=>k.map(c=>csvEsc(x[c])).join(','))].join('\n');}
function dlCsv(r,f){const b=new Blob([toCsv(r)],{type:'text/csv'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=f;a.click();}
function dlTxt(t,f){const b=new Blob([t],{type:'text/plain'});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=f;a.click();}

function parseCSV(text){
  if(text.charCodeAt(0)===0xFEFF)text=text.slice(1);
  const lines=[];let cur='',inQ=false;
  for(let i=0;i<text.length;i++){
    const c=text[i];
    if(c==='"'){if(inQ&&text[i+1]==='"'){cur+='"';i++;}else inQ=!inQ;}
    else if((c==='\n'||c==='\r')&&!inQ){if(c==='\r'&&text[i+1]==='\n')i++;if(cur.length||lines.length)lines.push(cur);cur='';}
    else cur+=c;
  }
  if(cur.length)lines.push(cur);
  if(!lines.length)return{headers:[],rows:[]};
  function split(l){const f=[];let s='',q=false;for(let i=0;i<l.length;i++){const c=l[i];if(c==='"'){if(q&&l[i+1]==='"'){s+='"';i++;}else q=!q;}else if(c===','&&!q){f.push(s);s='';}else s+=c;}f.push(s);return f;}
  const hdrs=split(lines[0]).map(h=>h.trim()),rows=[];
  for(let i=1;i<lines.length;i++){const v=split(lines[i]);if(v.every(x=>!x.trim()))continue;const o={};hdrs.forEach((h,j)=>o[h]=(v[j]||'').trim());rows.push(o);}
  return{headers:hdrs,rows};
}

function pTag(p){return p===true?'<span class="tag tag-p">‚ö° PoE</span>':p===false?'<span class="tag tag-n">üîå Non</span>':'<span class="tag tag-u">‚ùì</span>';}
function tTag(t){return `<span class="tag tag-t">${esc(t)}</span>`;}

function renderTbl(id,h,r){
  const w=document.getElementById(id);
  if(!r.length){w.innerHTML='<p class="cap" style="padding:8px">No data.</p>';return;}
  w.innerHTML='<table><thead><tr>'+h.map(x=>'<th>'+x+'</th>').join('')+'</tr></thead><tbody>'+
    r.map(row=>'<tr>'+row.map(c=>'<td>'+c+'</td>').join('')+'</tr>').join('')+'</tbody></table>';
}

// Auto-save
function autoSave(){try{localStorage.setItem('bom_autosave',JSON.stringify({bom:S.bom,switches:S.switches,assignments:S.assignments,chains:S.chains}));}catch(e){}}
function autoLoad(){try{const d=JSON.parse(localStorage.getItem('bom_autosave')||'null');if(d){S.bom=d.bom||[];S.switches=d.switches||[];S.assignments=d.assignments||[];S.chains=d.chains||[];}}catch(e){}}
autoLoad();

// ============================================================
// CSV + CATALOG
// ============================================================
document.getElementById('csvInput').addEventListener('change',function f(e){
  const file=e.target.files[0];if(!file)return;
  const r=new FileReader();r.onload=ev=>{
    const p=parseCSV(ev.target.result);S.rawRows=p.rows;S.headers=p.headers;
    document.getElementById('uploadZone').className='upl ok';
    document.getElementById('uploadZone').innerHTML='‚úÖ '+file.name+'<input type="file" id="csvInput" accept=".csv">';
    document.getElementById('csvInput').addEventListener('change',f);
    buildMapUI();document.getElementById('buildBtn').disabled=false;
  };r.readAsText(file);
});

function buildMapUI(){
  const c=document.getElementById('mapUI');c.innerHTML='';S.mapping={};
  [['product_name','Product Name *'],['product_type','Product Type'],['status','Item Status']].forEach(([k,l])=>{
    const a=pickCol(S.headers,CAND[k]||[]);S.mapping[k]=a;
    const s=document.createElement('select');s.innerHTML='<option value="">‚Äî</option>'+S.headers.map(h=>`<option value="${h}" ${h===a?'selected':''}>${h}</option>`).join('');
    s.addEventListener('change',()=>S.mapping[k]=s.value);
    const lb=document.createElement('label');lb.textContent=l;c.append(lb,s);
  });
}

document.getElementById('buildBtn').addEventListener('click',()=>{
  if(!S.mapping.product_name){alert('Product Name required.');return;}
  S.catalog={};
  S.rawRows.forEach(row=>{
    const n=(row[S.mapping.product_name]||'').trim();if(!n)return;
    const k=canon(n);if(!k)return;
    const t=(row[S.mapping.product_type]||'').trim(),st=(row[S.mapping.status]||'').trim().toLowerCase();
    if(!S.catalog[k])S.catalog[k]={product_name:n,product_type:t,total:0,in_stock:0,deployed:0,other:0};
    const e=S.catalog[k];e.total++;
    if(st==='in stock')e.in_stock++;else if(st==='deployed')e.deployed++;else e.other++;
  });
  document.getElementById('catStatus').innerHTML=`<div class="box box-ok" style="margin-top:6px">‚úì ${S.rawRows.length} rows ‚Üí ${Object.keys(S.catalog).length} products</div>`;
  showApp();
});

function showApp(){
  document.getElementById('noData').style.display='none';
  document.getElementById('app').style.display='block';
  renderCatPreview();renderBomSearch();renderBomTbl();
}

function renderCatPreview(){
  const e=Object.values(S.catalog).sort((a,b)=>a.product_name.localeCompare(b.product_name));
  renderTbl('catTbl',['Product','Type','Total','Stock','Deployed'],e.map(c=>[esc(c.product_name),tTag(c.product_type),c.total,c.in_stock,c.deployed]));
}

// ============================================================
// TABS
// ============================================================
document.getElementById('tabBar').addEventListener('click',e=>{
  const t=e.target.closest('.tab');if(!t)return;
  document.querySelectorAll('.tab').forEach(x=>x.classList.remove('on'));
  document.querySelectorAll('.tp').forEach(x=>x.classList.remove('on'));
  t.classList.add('on');document.getElementById('t-'+t.dataset.t).classList.add('on');
  if(t.dataset.t==='sw'){renderSwTbl();renderDcUI();}
  if(t.dataset.t==='wire')renderWireBoard();
  if(t.dataset.t==='out')renderOutTab();
});

// ============================================================
// BOM
// ============================================================
let srcRes=[];
document.getElementById('bomQ').addEventListener('input',renderBomSearch);

function renderBomSearch(){
  const q=(document.getElementById('bomQ').value||'').trim().toLowerCase();
  srcRes=[];
  if(q)Object.entries(S.catalog).forEach(([k,c])=>{if(`${c.product_name} | ${c.product_type}`.toLowerCase().includes(q))srcRes.push({...c,_k:k});});
  renderTbl('srcTbl',['Product','Type','Total','Stock'],srcRes.map(c=>[esc(c.product_name),tTag(c.product_type),c.total,c.in_stock]));
  const s=document.getElementById('srcSel');
  s.innerHTML=srcRes.map((c,i)=>`<option value="${i}">${esc(c.product_name)} [${esc(c.product_type)}]</option>`).join('');
  updStockH();
}

document.getElementById('srcSel').addEventListener('change',updStockH);
function updStockH(){const i=+document.getElementById('srcSel').value;const h=document.getElementById('stockH');if(isNaN(i)||!srcRes[i]){h.textContent='';return;}const c=srcRes[i];h.innerHTML=`Stock: <b>${c.in_stock}</b> / ${c.total}`;}

document.getElementById('addBomBtn').addEventListener('click',()=>{
  const i=+document.getElementById('srcSel').value;if(isNaN(i)||!srcRes[i])return;
  const c=srcRes[i],q=+(document.getElementById('addQty').value)||1,pk=canon(c.product_name);
  const ex=S.bom.find(b=>b.product_key===pk);
  if(ex)ex.qty+=q;else S.bom.push({product_key:pk,product_name:c.product_name,product_type:c.product_type,qty:q,poe:gPoe(c.product_name,c.product_type),notes:'',source:'Inventory',available_stock:c.in_stock,label_override:''});
  renderBomTbl();autoSave();
});

document.getElementById('addManBtn').addEventListener('click',()=>{
  const n=document.getElementById('mN').value.trim(),t=document.getElementById('mT').value.trim(),q=+(document.getElementById('mQ').value)||1;
  const pv=document.getElementById('mP').value;
  S.bom.push({product_key:canon(n)||`MAN-${S.bom.length}`,product_name:n||'Unnamed',product_type:t,qty:q,poe:pv===''?null:pv==='1',notes:'',source:'Manual',available_stock:0,label_override:''});
  renderBomTbl();autoSave();
});

function renderBomTbl(){
  if(!S.bom.length){document.getElementById('bomTbl').innerHTML='<p class="cap" style="padding:8px">Empty.</p>';document.getElementById('bomEd').innerHTML='';return;}
  renderTbl('bomTbl',['Product','Type','Qty','PoE'],S.bom.map(b=>[esc(b.product_name),tTag(b.product_type),b.qty,pTag(b.poe)]));
  renderBomEd();
}

function renderBomEd(){
  const c=document.getElementById('bomEd');if(!S.bom.length){c.innerHTML='';return;}
  c.innerHTML=`<div class="row" style="margin-top:6px">
    <div><label>Edit</label><select id="bSel">${S.bom.map((b,i)=>`<option value="${i}">${esc(b.product_name)}</option>`).join('')}</select></div>
    <div style="max-width:60px"><label>Qty</label><input type="number" id="bQty" min="0" value="${S.bom[0].qty}"></div>
    <div><label>PoE</label><select id="bPoe"><option value="">‚Äî</option><option value="1">PoE</option><option value="0">Non</option></select></div>
  </div>
  <label>Diagram Label</label><input type="text" id="bLbl" placeholder="Optional override">
  <div class="br"><button class="btn btn-sm" id="bSave">Save</button><button class="btn btn-sm" id="bRm">Remove</button><button class="btn btn-sm" id="bClr">Clear All</button></div>`;

  const load=()=>{const i=+document.getElementById('bSel').value,b=S.bom[i];if(!b)return;
    document.getElementById('bQty').value=b.qty;document.getElementById('bPoe').value=b.poe===null?'':b.poe?'1':'0';document.getElementById('bLbl').value=b.label_override||'';};
  document.getElementById('bSel').addEventListener('change',load);load();

  document.getElementById('bSave').addEventListener('click',()=>{
    const i=+document.getElementById('bSel').value,b=S.bom[i];if(!b)return;
    b.qty=+(document.getElementById('bQty').value)||0;const pv=document.getElementById('bPoe').value;b.poe=pv===''?null:pv==='1';
    b.label_override=document.getElementById('bLbl').value;renderBomTbl();autoSave();
  });
  document.getElementById('bRm').addEventListener('click',()=>{
    const i=+document.getElementById('bSel').value;S.bom.splice(i,1);
    S.assignments=S.assignments.filter(a=>a.bom_index!==i);S.assignments.forEach(a=>{if(a.bom_index>i)a.bom_index--;});
    renderBomTbl();autoSave();
  });
  document.getElementById('bClr').addEventListener('click',()=>{if(!confirm('Clear BOM?'))return;S.bom=[];S.assignments=[];renderBomTbl();autoSave();});
}

// ============================================================
// SWITCHES
// ============================================================
document.getElementById('addSwBtn').addEventListener('click',()=>{
  let id=(document.getElementById('sI').value||'').trim().toUpperCase().replace(/\s/g,'_');if(!id)id='SW'+S.switches.length;
  if(S.switches.some(s=>s.switch_id===id)){alert('ID exists');return;}
  S.switches.push({switch_id:id,name:document.getElementById('sN').value.trim()||id,model:document.getElementById('sM').value.trim(),
    is_poe:document.getElementById('sT').value==='1',poe_ports:+(document.getElementById('sPP').value)||0,data_ports:+(document.getElementById('sDP').value)||0,
    subtitle:document.getElementById('sSub').value.trim()});
  ['sI','sN','sM','sSub'].forEach(x=>document.getElementById(x).value='');
  renderSwTbl();renderDcUI();autoSave();
});

function renderSwTbl(){
  if(!S.switches.length){document.getElementById('swTbl').innerHTML='<p class="cap" style="padding:8px">No switches.</p>';document.getElementById('swAct').innerHTML='';return;}
  renderTbl('swTbl',['ID','Name','Model','Type','PoE','Data','Sub'],S.switches.map(s=>[s.switch_id,esc(s.name),esc(s.model),s.is_poe?'<span class="tag tag-p">PoE</span>':'<span class="tag tag-n">Data</span>',s.poe_ports,s.data_ports,esc(s.subtitle)]));
  document.getElementById('swAct').innerHTML=`<select id="rmSw"><option value="">‚Äî Remove ‚Äî</option>${S.switches.map(s=>`<option value="${s.switch_id}">${s.switch_id}</option>`).join('')}</select><button class="btn btn-sm" id="rmSwBtn">Remove</button>`;
  document.getElementById('rmSwBtn').addEventListener('click',()=>{const id=document.getElementById('rmSw').value;if(!id)return;S.switches=S.switches.filter(s=>s.switch_id!==id);S.assignments=S.assignments.filter(a=>a.switch_id!==id);S.chains=S.chains.filter(c=>c.from_switch!==id&&c.to_switch!==id);renderSwTbl();renderDcUI();autoSave();});
}

function renderDcUI(){
  const c=document.getElementById('dcUI'),a=document.getElementById('dcAct');
  if(S.switches.length<2){c.innerHTML='<p class="cap">Need 2+ switches.</p>';renderDcTbl();return;}
  const o=S.switches.map(s=>`<option value="${s.switch_id}">${s.switch_id}</option>`).join('');
  c.innerHTML=`<div class="row"><div><label>From</label><select id="dcF">${o}</select></div><div><label>Port</label><input type="text" id="dcFP" value="Data 1"></div><div><label>To</label><select id="dcT">${o}</select></div><div><label>Port</label><input type="text" id="dcTP" value="Port 1"></div><div style="max-width:80px;padding-top:14px"><button class="btn btn-sm btn-p" id="addDc">Add</button></div></div>`;
  document.getElementById('addDc').addEventListener('click',()=>{const f=document.getElementById('dcF').value,t=document.getElementById('dcT').value;if(f===t){alert('Cannot self-chain');return;}S.chains.push({from_switch:f,from_port_label:document.getElementById('dcFP').value||'Data 1',to_switch:t,to_port_label:document.getElementById('dcTP').value||'Port 1'});renderDcTbl();autoSave();});
  renderDcTbl();
}

function renderDcTbl(){
  if(!S.chains.length){document.getElementById('dcTbl').innerHTML='';document.getElementById('dcAct').innerHTML='';return;}
  renderTbl('dcTbl',['From','Port','To','Port'],S.chains.map(c=>[c.from_switch,esc(c.from_port_label),c.to_switch,esc(c.to_port_label)]));
  document.getElementById('dcAct').innerHTML='<button class="btn btn-sm" id="clrDc">Clear chains</button>';
  document.getElementById('clrDc').addEventListener('click',()=>{S.chains=[];renderDcTbl();autoSave();});
}

// ============================================================
// WIRING BOARD (drag & drop)
// ============================================================
let dragData=null; // {bom_index, instance, label, poe}

function allInstances(){
  const all=[];
  S.bom.forEach((b,idx)=>{for(let i=1;i<=b.qty;i++){const sfx=b.qty>1?` no.${i}`:'';all.push({bom_index:idx,instance:i,label:(b.label_override||b.product_name)+sfx,product_type:b.product_type,poe:b.poe});}});
  return all;
}

function renderWireBoard(){
  // Device pool
  const pool=document.getElementById('devPool');pool.innerHTML='';
  const assignedSet=new Set(S.assignments.map(a=>`${a.bom_index}:${a.instance}`));
  const unassigned=allInstances().filter(d=>!assignedSet.has(`${d.bom_index}:${d.instance}`));

  unassigned.forEach((d,i)=>{
    const chip=document.createElement('div');
    chip.className='pool-chip'+(d.poe===true?' poe':d.poe===false?' non':'');
    chip.textContent=(d.poe===true?'üü¢ ':d.poe===false?'üîµ ':'‚ùì ')+d.label;
    chip.draggable=true;
    chip.addEventListener('dragstart',e=>{dragData=d;e.dataTransfer.effectAllowed='move';chip.style.opacity='.5';});
    chip.addEventListener('dragend',()=>{chip.style.opacity='1';dragData=null;});
    // Click-to-assign
    chip.addEventListener('click',()=>{
      if(selectedSlot){assignToSlot(selectedSlot.swId,selectedSlot.portNum,selectedSlot.portType,d);selectedSlot=null;renderWireBoard();}
    });
    pool.appendChild(chip);
  });

  if(!unassigned.length&&S.bom.length)pool.innerHTML='<p class="cap" style="padding:4px">‚úì All assigned</p>';
  if(!S.bom.length)pool.innerHTML='<p class="cap" style="padding:4px">Add BOM items first</p>';

  // Switch columns
  const board=document.getElementById('wireBoard');board.innerHTML='';
  S.switches.forEach(sw=>{
    const col=document.createElement('div');col.className='sw-col';
    const hdr=document.createElement('div');hdr.className='sw-hdr '+(sw.is_poe?'poe':'data');
    hdr.innerHTML=`${esc(sw.name)}<br><span style="font-size:10px;opacity:.8">${esc(sw.model)}</span>`;
    col.appendChild(hdr);

    const totalPorts=sw.poe_ports+sw.data_ports;
    for(let p=1;p<=totalPorts;p++){
      const isPoePort=p<=sw.poe_ports;
      const portType=isPoePort?'PoE':'Data';
      const portNum=isPoePort?p:p-sw.poe_ports;

      const slot=document.createElement('div');slot.className='port-slot';
      slot.dataset.sw=sw.switch_id;slot.dataset.port=p;slot.dataset.ptype=portType;slot.dataset.pnum=portNum;

      const lbl=document.createElement('span');lbl.className='port-lbl';lbl.textContent=`${portType} ${portNum}`;
      slot.appendChild(lbl);

      // Check if assigned
      const assigned=S.assignments.find(a=>a.switch_id===sw.switch_id&&a.port_number===p);
      if(assigned){
        const b=S.bom[assigned.bom_index];
        const emoji=b&&b.poe===true?'üü¢':b&&b.poe===false?'üîµ':'‚ùì';
        const chip=document.createElement('div');chip.className='dev-chip';
        chip.draggable=true;
        chip.innerHTML=`${emoji} ${esc(assigned.device_label)}<span class="x" title="Remove">√ó</span>`;
        chip.addEventListener('dragstart',e=>{
          dragData={bom_index:assigned.bom_index,instance:assigned.instance,label:assigned.device_label,poe:b?b.poe:null,fromSlot:{swId:sw.switch_id,port:p}};
          e.dataTransfer.effectAllowed='move';chip.style.opacity='.5';
        });
        chip.addEventListener('dragend',()=>{chip.style.opacity='1';dragData=null;});
        chip.querySelector('.x').addEventListener('click',e=>{
          e.stopPropagation();
          S.assignments=S.assignments.filter(a=>!(a.switch_id===sw.switch_id&&a.port_number===p));
          renderWireBoard();autoSave();
        });
        slot.appendChild(chip);
      }else{
        const empty=document.createElement('span');empty.textContent='empty';empty.style.cssText='color:var(--mu);font-style:italic;font-size:11px';
        slot.appendChild(empty);slot.classList.add('empty');
      }

      // Drop target
      slot.addEventListener('dragover',e=>{e.preventDefault();slot.classList.add('drag-over');});
      slot.addEventListener('dragleave',()=>slot.classList.remove('drag-over'));
      slot.addEventListener('drop',e=>{
        e.preventDefault();slot.classList.remove('drag-over');
        if(!dragData)return;
        // If moving from another slot, remove old assignment
        if(dragData.fromSlot){S.assignments=S.assignments.filter(a=>!(a.switch_id===dragData.fromSlot.swId&&a.port_number===dragData.fromSlot.port));}
        // Remove any existing assignment in this slot
        S.assignments=S.assignments.filter(a=>!(a.switch_id===sw.switch_id&&a.port_number===p));
        assignToSlot(sw.switch_id,p,portType,dragData);
        dragData=null;renderWireBoard();
      });

      // Click to select slot
      slot.addEventListener('click',()=>{
        if(!slot.classList.contains('empty'))return;
        document.querySelectorAll('.port-slot').forEach(s=>s.style.outline='');
        slot.style.outline='2px solid var(--blu)';
        selectedSlot={swId:sw.switch_id,portNum:p,portType};
      });

      col.appendChild(slot);
    }
    board.appendChild(col);
  });
}

let selectedSlot=null;

function assignToSlot(swId,portNum,portType,dev){
  // Remove existing assignment at this slot
  S.assignments=S.assignments.filter(a=>!(a.switch_id===swId&&a.port_number===portNum));
  S.assignments.push({
    switch_id:swId,port_number:portNum,port_type:portType,
    bom_index:dev.bom_index,instance:dev.instance,
    device_label:dev.label,node_id:nid(dev.label,S.assignments.length)
  });
  autoSave();
}

// ============================================================
// OUTPUT
// ============================================================
function renderOutTab(){
  const issues=[];
  if(!S.bom.length)issues.push('No BOM items');
  else if(S.bom.some(b=>b.poe===null))issues.push('Some items need PoE classification (Tab ‚ë†)');
  if(!S.switches.length)issues.push('No switches (Tab ‚ë°)');
  if(!S.assignments.length)issues.push('No wiring (Tab ‚ë¢)');
  const tot=S.bom.reduce((s,b)=>s+b.qty,0);
  if(tot>0&&S.assignments.length<tot)issues.push(`${tot-S.assignments.length} device(s) unassigned (Tab ‚ë¢)`);
  document.getElementById('outIssues').innerHTML=issues.map(i=>`<div class="box box-w">${i}</div>`).join('');

  const pc=S.bom.filter(b=>b.poe===true).reduce((s,b)=>s+b.qty,0);
  const nc=S.bom.filter(b=>b.poe===false).reduce((s,b)=>s+b.qty,0);
  document.getElementById('outMet').innerHTML=S.bom.length?`<div class="mc"><div class="v" style="color:var(--grn)">${pc}</div><div class="l">‚ö° PoE</div></div><div class="mc"><div class="v" style="color:var(--blu)">${nc}</div><div class="l">üîå Non-PoE</div></div><div class="mc"><div class="v">${pc+nc}</div><div class="l">üì¶ Total</div></div>`:'';
  document.getElementById('genBtn').disabled=!(S.bom.length&&S.switches.length);
}

document.getElementById('genBtn').addEventListener('click',()=>{
  const txt=genMermaid();
  document.getElementById('mOut').value=txt;
  document.getElementById('outRes').style.display='block';
  // Live preview
  renderMermaidPreview(txt);
});

function renderMermaidPreview(code){
  const el=document.getElementById('mermaidPreview');
  if(typeof mermaid!=='undefined'){
    el.innerHTML='';
    // mermaid.render returns promise in v10+
    try{
      const id='mm'+Date.now();
      mermaid.render(id,code).then(({svg})=>{el.innerHTML=svg;}).catch(()=>{el.innerHTML='<p class="cap">Preview render failed. Code is still valid ‚Äî copy and paste into any Mermaid renderer.</p>';});
    }catch(e){el.innerHTML='<p class="cap">Preview unavailable. Copy code below.</p>';}
  }else{
    el.innerHTML='<p class="cap">Live preview requires internet (mermaid.js). Code is ready to copy.</p>';
  }
}

document.getElementById('copyBtn').addEventListener('click',()=>{navigator.clipboard.writeText(document.getElementById('mOut').value);document.getElementById('copyBtn').textContent='‚úÖ Copied!';setTimeout(()=>document.getElementById('copyBtn').textContent='üìã Copy',2000);});
document.getElementById('dlMmdBtn').addEventListener('click',()=>dlTxt(document.getElementById('mOut').value,(document.getElementById('dTitle').value||'diagram').replace(/\s+/g,'_')+'.mmd'));
document.getElementById('dlBomBtn').addEventListener('click',()=>dlCsv(S.bom.filter(b=>b.qty>0).map(b=>({Product:b.product_name,Type:b.product_type,Qty:b.qty,PoE:b.poe===true?'PoE':'Non-PoE',Notes:b.notes})),'BOM.csv'));
document.getElementById('dlPoeBtn').addEventListener('click',()=>dlCsv(S.bom.filter(b=>b.poe===true&&b.qty>0).map(b=>({Product:b.product_name,Type:b.product_type,Qty:b.qty})),'BOM_PoE.csv'));
document.getElementById('dlNonBtn').addEventListener('click',()=>dlCsv(S.bom.filter(b=>b.poe===false&&b.qty>0).map(b=>({Product:b.product_name,Type:b.product_type,Qty:b.qty})),'BOM_NonPoE.csv'));

// ============================================================
// TEMPLATES
// ============================================================
document.getElementById('saveTplBtn').addEventListener('click',()=>{
  const name=document.getElementById('tplName').value.trim();if(!name){alert('Enter a template name.');return;}
  const tpl={name,desc:document.getElementById('tplDesc').value.trim(),date:new Date().toISOString().slice(0,10),
    bom:JSON.parse(JSON.stringify(S.bom)),switches:JSON.parse(JSON.stringify(S.switches)),
    assignments:JSON.parse(JSON.stringify(S.assignments)),chains:JSON.parse(JSON.stringify(S.chains))};
  S.templates.push(tpl);
  localStorage.setItem('bom_templates',JSON.stringify(S.templates));
  renderTplSidebar();
  alert(`Template "${name}" saved!`);
});

function renderTplSidebar(){
  const c=document.getElementById('tplSidebar');
  if(!S.templates.length){c.innerHTML='<p class="cap">No templates yet. Build a config and save it from Tab ‚ë£.</p>';return;}
  c.innerHTML=S.templates.map((t,i)=>`
    <div class="tpl-card" style="margin-bottom:8px">
      <h3>${esc(t.name)}</h3>
      <p>${esc(t.desc||'No description')}</p>
      <div class="tpl-meta"><span>${t.date||''}</span><span>${(t.bom||[]).length} items</span><span>${(t.switches||[]).length} switches</span></div>
      <div class="tpl-act" style="margin-top:6px">
        <button class="btn btn-sm btn-b" onclick="loadTpl(${i})">Load</button>
        <button class="btn btn-sm" onclick="dlTpl(${i})">‚¨á Export</button>
        <button class="btn btn-sm" onclick="rmTpl(${i})" style="color:var(--red)">‚úï</button>
      </div>
    </div>
  `).join('');
}

window.loadTpl=function(i){
  const t=S.templates[i];if(!t)return;
  if(!confirm(`Load template "${t.name}"? This will replace your current BOM, switches, and wiring.`))return;
  S.bom=JSON.parse(JSON.stringify(t.bom||[]));
  S.switches=JSON.parse(JSON.stringify(t.switches||[]));
  S.assignments=JSON.parse(JSON.stringify(t.assignments||[]));
  S.chains=JSON.parse(JSON.stringify(t.chains||[]));
  autoSave();
  // If catalog exists show app, otherwise just show it anyway
  document.getElementById('noData').style.display='none';
  document.getElementById('app').style.display='block';
  renderBomTbl();
};

window.dlTpl=function(i){const t=S.templates[i];if(!t)return;dlTxt(JSON.stringify(t,null,2),(t.name||'template').replace(/\s+/g,'_')+'.json');};
window.rmTpl=function(i){if(!confirm('Delete this template?'))return;S.templates.splice(i,1);localStorage.setItem('bom_templates',JSON.stringify(S.templates));renderTplSidebar();};

renderTplSidebar();

// Project save/load
document.getElementById('saveProjectBtn').addEventListener('click',()=>{
  const proj={bom:S.bom,switches:S.switches,assignments:S.assignments,chains:S.chains,catalog:S.catalog};
  dlTxt(JSON.stringify(proj,null,2),'bom_project.json');
});

document.getElementById('loadProjectBtn').addEventListener('click',()=>document.getElementById('loadProjectInput').click());
document.getElementById('loadProjectInput').addEventListener('change',e=>{
  const f=e.target.files[0];if(!f)return;
  const r=new FileReader();r.onload=ev=>{
    try{
      const d=JSON.parse(ev.target.result);
      // Could be a template or a full project
      S.bom=d.bom||[];S.switches=d.switches||[];S.assignments=d.assignments||[];S.chains=d.chains||[];
      if(d.catalog&&Object.keys(d.catalog).length)S.catalog=d.catalog;
      autoSave();showApp();renderBomTbl();
      alert('Project loaded!');
    }catch(err){alert('Invalid JSON file.');}
  };r.readAsText(f);
});

// If we have autosaved data, show the app
if(S.bom.length||S.switches.length){
  document.getElementById('noData').style.display='none';
  document.getElementById('app').style.display='block';
  renderBomTbl();
}

// ============================================================
// MERMAID GENERATOR
// ============================================================
function genMermaid(){
  const title=document.getElementById('dTitle').value||'Switch Network Diagram';
  const {switches,assignments,chains,bom}=S;
  const L=[];

  L.push('---',`title: ${esc(title)}`,'---','','flowchart TD','');
  L.push('  subgraph LEGEND["Legend"]','    direction LR','    LA["üü¢ PoE Device"]','    LB["üîµ Non-PoE Device"]','    LC["üü° Special System"]','    LD["‚¨ú Spare Port"]','  end','');

  const swA={};switches.forEach(sw=>swA[sw.switch_id]=[]);
  assignments.forEach(a=>{if(swA[a.switch_id])swA[a.switch_id].push(a);});
  Object.values(swA).forEach(arr=>arr.sort((a,b)=>a.port_number-b.port_number));
  const cc=sid=>chains.filter(c=>c.from_switch===sid||c.to_switch===sid).length;

  switches.forEach(sw=>{
    const pp=[];if(sw.poe_ports>0)pp.push(`${sw.poe_ports}x PoE`);if(sw.data_ports>0)pp.push(`${sw.data_ports}x Data`);
    L.push(`  subgraph ${sw.switch_id}["${esc(sw.name)}"]`);
    let info=esc(sw.model);if(pp.length)info+=`<br>${pp.join(' ‚Äî ')}`;
    L.push(`    ${sw.switch_id}_INFO["${info}"]`,'  end','');
  });

  switches.forEach(sw=>{
    const devs=swA[sw.switch_id],tot=sw.poe_ports+sw.data_ports,nC=cc(sw.switch_id),nS=Math.max(tot-devs.length-nC,0);
    const pu=devs.filter(d=>d.port_type==='PoE').length,du=devs.filter(d=>d.port_type==='Data').length;
    const pts=[];if(pu>0&&sw.poe_ports>0)pts.push(`${pu} of ${sw.poe_ports} PoE`);if(du>0)pts.push(`${du} data`);if(nC>0)pts.push(`${nC} chain`);
    let sm=pts.join(' + ');if(sm)sm+=` = ${devs.length+nC} of ${tot}`;
    let st=esc(sw.name);if(sw.subtitle)st+=` ‚Äî ${esc(sw.subtitle)}`;if(sm)st+=` ‚Äî ${sm}`;

    L.push(`  subgraph ${sw.switch_id}_DEV["${st}"]`,'    direction TB');
    devs.forEach(a=>{const b=bom[a.bom_index];const e=b&&b.poe===true?'üü¢':b&&b.poe===false?'üîµ':'‚¨ú';L.push(`    ${a.node_id}["${e} ${esc(a.device_label)}"]`);});
    for(let s=0;s<nS;s++){const sT=(sw.is_poe&&(pu+s)<sw.poe_ports)?'PoE':'Data';L.push(`    ${sw.switch_id}_SP_${s}["‚¨ú Spare ${sT}"]`);}
    L.push('  end','');
  });

  switches.forEach(sw=>{
    const devs=swA[sw.switch_id],tot=sw.poe_ports+sw.data_ports,nC=cc(sw.switch_id),nS=Math.max(tot-devs.length-nC,0),pu=devs.filter(d=>d.port_type==='PoE').length;
    devs.forEach(a=>L.push(`  ${sw.switch_id} -- ${a.port_type} ${a.port_number} --> ${a.node_id}`));
    for(let s=0;s<nS;s++){const sT=(sw.is_poe&&(pu+s)<sw.poe_ports)?'PoE':'Data';L.push(`  ${sw.switch_id} -. ${sT} Spare .-> ${sw.switch_id}_SP_${s}`);}
    L.push('');
  });

  chains.forEach(ch=>L.push(`  ${ch.from_switch} <==>|Daisy Chain<br>${esc(ch.from_port_label)} to ${esc(ch.to_port_label)}| ${ch.to_switch}`));
  if(chains.length)L.push('');

  L.push('  classDef poeSwitch fill:#14532d,stroke:#22c55e,stroke-width:2px,color:#fff');
  L.push('  classDef dataSwitch fill:#1e3a5f,stroke:#3b82f6,stroke-width:2px,color:#fff');
  L.push('  classDef poeDevice fill:#14532d,stroke:#4ade80,stroke-width:1.5px,color:#bbf7d0');
  L.push('  classDef dataDevice fill:#1e3a5f,stroke:#60a5fa,stroke-width:1.5px,color:#bfdbfe');
  L.push('  classDef special fill:#713f12,stroke:#eab308,stroke-width:2px,color:#fef9c3');
  L.push('  classDef spare fill:#1a1a1a,stroke:#4a5568,stroke-width:1px,stroke-dasharray:5 5,color:#4a5568');
  L.push('  classDef legendBox fill:#0f0f0f,stroke:#333,stroke-width:1px,color:#888','');

  const ps=switches.filter(s=>s.is_poe).map(s=>`${s.switch_id}_INFO`),ds=switches.filter(s=>!s.is_poe).map(s=>`${s.switch_id}_INFO`);
  if(ps.length)L.push(`  class ${ps.join(',')} poeSwitch`);if(ds.length)L.push(`  class ${ds.join(',')} dataSwitch`);
  const pn=assignments.filter(a=>bom[a.bom_index]&&bom[a.bom_index].poe===true).map(a=>a.node_id);
  const dn=assignments.filter(a=>bom[a.bom_index]&&bom[a.bom_index].poe===false).map(a=>a.node_id);
  if(pn.length)L.push(`  class ${pn.join(',')} poeDevice`);if(dn.length)L.push(`  class ${dn.join(',')} dataDevice`);
  const sn=[];switches.forEach(sw=>{const tot=sw.poe_ports+sw.data_ports,nD=swA[sw.switch_id].length,nC=cc(sw.switch_id);for(let s=0;s<Math.max(tot-nD-nC,0);s++)sn.push(`${sw.switch_id}_SP_${s}`);});
  if(sn.length)L.push(`  class ${sn.join(',')} spare`);
  L.push('  class LA,LB,LC,LD legendBox');
  return L.join('\n');
}

// Try loading mermaid.js for live preview (optional, non-blocking)
(function(){const s=document.createElement('script');s.src='https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js';
  s.onload=()=>{mermaid.initialize({startOnLoad:false,theme:'dark',securityLevel:'loose'});};
  s.onerror=()=>{};document.head.appendChild(s);
})();
</script>
</body>
</html>
